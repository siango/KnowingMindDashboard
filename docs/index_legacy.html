  <script src="config.env.js?v=20250909230447"></script>
  <script src="js/gas-client.js?v=20250909230447"></script>
<!doctype html><html lang="th"><meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>[build:20250909232154] [build:20250909230447] KnowingMind Dashboard</title>
<style>
  :root{--bg:#0b1020;--card:#10172a;--text:#e5e7eb;--muted:#9ca3af;--line:#2a3655;--pos:#22c55e;--zero:#9ca3af;}
  @media (prefers-color-scheme: light){
    :root{--bg:#f6f7fb;--card:#ffffff;--text:#1f2937;--muted:#6b7280;--line:#e5e7eb;--pos:#15803d;--zero:#9ca3af;}
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto,Prompt,sans-serif}
  .wrap{max-width:980px;margin:auto;padding:20px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,.15)}
  h1{margin:0 0 4px 0;font-size:24px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:14px}
  .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(170px,1fr));gap:10px;margin:8px 0 14px}
  .kpi{border:1px solid var(--line);border-radius:12px;padding:12px}
  .kpi .t{font-size:12px;color:var(--muted)}
  .kpi .v{font-weight:700;font-size:20px}
  table{width:100%;border-collapse:collapse;margin-top:10px;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  th,td{padding:10px 12px;border-bottom:1px solid var(--line);text-align:center}
  th{background:rgba(255,255,255,.04)}
  tbody tr:last-child td{border-bottom:none}
  .pos{color:var(--pos);font-weight:700}
  .zero{color:var(--zero)}
  h2{margin:18px 0 8px 0;font-size:18px}
  ul{margin:8px 0 0 18px}
</style>
<body><script>
(async () => {
  // ping à¹à¸šà¸š health
  const health = await window.KMS.gasFetch({ action: 'health', source: 'pages' }, 'GET');
  console.log('health:', health);

  // à¸¥à¸­à¸‡à¹‚à¸«à¸¥à¸” dashboard (à¸–à¹‰à¸² Apps Script à¸£à¸­à¸‡à¸£à¸±à¸š)
  try {
    const data = await window.KMS.gasFetch({ action: 'dashboard' }, 'GET');
    const el = document.querySelector('[data-km="dashboard-json"]');
    if (el) el.textContent = JSON.stringify({ health, dashboard: data }, null, 2);
  } catch (e) {
    const el = document.querySelector('[data-km="dashboard-json"]');
    if (el) el.textContent = JSON.stringify({ health, note: 'dashboard() not available', error: e.message }, null, 2);
  }
})();
</script>
<div class="wrap">
  <div class="card">
    <h1>ðŸ“Š KnowingMind Dashboard</h1>
    <div id="machines-card" class="card" style="margin-top:16px;">
      <h2>à¸ªà¸–à¸²à¸™à¸°à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡</h2>
      <div id="machines-note" class="muted">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”â€¦</div>
      <div style="overflow:auto">
        <table id="machines-table" style="display:none"><thead><tr><th>à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡</th><th>à¸­à¸±à¸›à¹€à¸”à¸—à¸¥à¹ˆà¸²à¸ªà¸¸à¸”</th><th>à¸ªà¸–à¸²à¸™à¸°</th><th>à¸à¸²à¸£à¹à¸à¹‰à¹„à¸‚</th></tr></thead><tbody></tbody></table>
      </div>
    </div>
    <div class="sub">à¸­à¸±à¸›à¹€à¸”à¸•à¸¥à¹ˆà¸²à¸ªà¸¸à¸”: <span id="lastUpdate">-</span></div>

    <div class="kpis">
      <div class="kpi"><div class="t">à¸¡à¸¹à¸¥à¸„à¹ˆà¸²à¸£à¸§à¸¡ (Mà¸¿)</div><div class="v" id="k_sum">-</div></div>
      <div class="kpi"><div class="t">à¹€à¸žà¸´à¹ˆà¸¡à¸‚à¸¶à¹‰à¸™à¸§à¸±à¸™à¸™à¸µà¹‰ (Mà¸¿)</div><div class="v" id="k_delta">-</div></div>
      <div class="kpi"><div class="t">à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œà¸—à¸µà¹ˆà¸‚à¸¢à¸±à¸šà¸‚à¸¶à¹‰à¸™</div><div class="v" id="k_up">-</div></div>
    </div>

    <h2>à¸•à¸²à¸£à¸²à¸‡à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™â€“à¸§à¸±à¸™à¸™à¸µà¹‰</h2>
    <table id="tblMain"><thead>
      <tr><th>Project</th><th>Progress à¹€à¸¡à¸·à¹ˆà¸­à¸§à¸²à¸™</th><th>à¸§à¸±à¸™à¸™à¸µà¹‰</th><th>Valuation (Mà¸¿)</th><th>à¸¡à¸¹à¸¥à¸„à¹ˆà¸²à¹€à¸žà¸´à¹ˆà¸¡ (Mà¸¿)</th></tr>
    </thead><tbody></tbody></table>

    <h2>à¸•à¸²à¸£à¸²à¸‡à¸¡à¸¹à¸¥à¸„à¹ˆà¸²à¹€à¸žà¸´à¹ˆà¸¡ + à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</h2>
    <table id="tblDelta"><thead>
      <tr><th>Project</th><th>à¸¡à¸¹à¸¥à¸„à¹ˆà¸²à¹€à¸žà¸´à¹ˆà¸¡ (Mà¸¿)</th><th>à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸</th></tr>
    </thead><tbody></tbody></table>

    <h2>à¸ªà¸£à¸¸à¸›à¸ à¸²à¸žà¸£à¸§à¸¡</h2>
    <ul id="summary"></ul>

    <h2>Checklist à¸§à¸±à¸™à¸™à¸µà¹‰</h2>
    <ul id="cks"></ul>
  </div>
</div>

<script>
async function get(url){const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error(url); return r.text();}
function csvRows(txt){return txt.trim().split(/\r?\n/).slice(1).map(r=>r.split(','));}

(async()=>{
  document.getElementById('lastUpdate').textContent =
    new Date().toLocaleString('th-TH',{hour12:false});

  // --- à¸•à¸²à¸£à¸²à¸‡à¸«à¸¥à¸±à¸ ---
  const rows = csvRows(await get('projects_today.csv'));
  let sum=0, delta=0, ups=[];
  const tb = document.querySelector('#tblMain tbody');
  rows.forEach(([p,y,t,v,d])=>{
    sum += Number(v||0);
    delta += Number(d||0);
    if(Number(d)>0) ups.push(p);
    tb.insertAdjacentHTML('beforeend',
      `<tr><td style="text-align:left">${p}</td>
           <td>${y}%</td><td><b>${t}%</b></td><td>${v}</td>
           <td class="${(+d>0)?'pos':'zero'}">${d}</td></tr>`);
  });

  // --- à¸ªà¸£à¸¸à¸›à¹€à¸¥à¸‚à¸šà¸™ ---
  document.getElementById('k_sum').textContent   = sum.toLocaleString('th-TH');
  document.getElementById('k_delta').textContent = `+${delta.toLocaleString('th-TH')}`;
  document.getElementById('k_up').textContent    = ups.length;

  // --- à¹€à¸«à¸•à¸¸à¸œà¸¥à¸¡à¸¹à¸¥à¸„à¹ˆà¸²à¹€à¸žà¸´à¹ˆà¸¡ ---
  try{
    const reasons = JSON.parse(await get('delta_reason.json'));
    const tb2 = document.querySelector('#tblDelta tbody');
    reasons.forEach(o=>{
      tb2.insertAdjacentHTML('beforeend',
        `<tr><td style="text-align:left">${o.project}</td>
             <td class="${(o.delta>0)?'pos':'zero'}">${o.delta}</td>
             <td style="text-align:left">${o.reason}</td></tr>`);
    });
  }catch(e){}

  // --- à¸ªà¸£à¸¸à¸›à¸ à¸²à¸žà¸£à¸§à¸¡ ---
  const s = document.getElementById('summary');
  s.insertAdjacentHTML('beforeend',
    `<li>ðŸ“ˆ Valuation à¸£à¸§à¸¡à¹€à¸žà¸´à¹ˆà¸¡à¸‚à¸¶à¹‰à¸™à¸§à¸±à¸™à¸™à¸µà¹‰: +${delta} Mà¸¿ (à¸£à¸§à¸¡ â‰ˆ ${sum} Mà¸¿)</li>`);
  s.insertAdjacentHTML('beforeend',
    `<li>ðŸ”¼ à¹‚à¸›à¸£à¹€à¸ˆà¸à¸•à¹Œà¸—à¸µà¹ˆà¸‚à¸¢à¸±à¸šà¸Šà¸±à¸”à¹€à¸ˆà¸™: ${ups.join(', ') || 'â€”'}</li>`);

  // --- Checklist ---
  try{
    const ck = JSON.parse(await get('checklist.json'));
    const ul = document.getElementById('cks');
    ck.forEach(t=>ul.insertAdjacentHTML('beforeend', `<li>${t}</li>`));
  }catch(e){}
})();
</script>
  <!-- KM-MACHINES-START -->
  <script>
  async function loadMachines(){
    const note=document.getElementById("machines-note");
    const table=document.getElementById("machines-table");
    const tbody=table.querySelector("tbody");
    try{
      const res=await fetch("data.json",{cache:"no-store"});
      if(!res.ok) throw new Error("HTTP "+res.status);
      const data=await res.json();
      const items=Array.isArray(data.machines)?data.machines:[];
      if(items.length===0){note.textContent="à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸žà¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡";return;}
      items.sort((a,b)=>new Date(b.last_update||0)-new Date(a.last_update||0));
      tbody.innerHTML=items.map(m=>{
        const t=m.last_update?new Date(m.last_update).toLocaleString():"-";
        const badge=(m.status||"").toLowerCase()==="ok"?"âœ… ok":(m.status||"-");
        return `<tr><td>${m.machine_id||"-"}</td><td>${t}</td><td>${badge}</td></tr>`;
      }).join("");
      note.style.display="none";
      table.style.display="table";
    }catch(e){note.textContent="à¹‚à¸«à¸¥à¸”à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹„à¸¡à¹ˆà¸ªà¸³à¹€à¸£à¹‡à¸ˆ";console.error(e);}
  }
  document.addEventListener("DOMContentLoaded",loadMachines);
  </script>
  <!-- KM-MACHINES-END -->
<div id="ai-banner" style="position:sticky;top:0;z-index:1000;background:#111827;color:#fff;padding:10px 14px;border-radius:12px;margin:8px 0">
  <span id="ai-status">Loading…</span>
</div>
<script>
(async () => {
  try {
    const h = await window.KMS.gasFetch({ action:'health', source:'pages' }, 'GET');
    let text = 'health: ' + (h && h.ping || '—');
    try {
      const d = await window.KMS.gasFetch({ action:'dashboard' }, 'GET');
      text += ' | dashboard: ok (' + (d && d.summary && d.summary.progress ? (d.summary.progress.today_percent+'%') : '—') + ')';
    } catch (e) { text += ' | dashboard: ' + e.message; }
    document.getElementById('ai-status').textContent = text + ' @ ' + new Date().toLocaleString('th-TH');
  } catch(e){
    document.getElementById('ai-status').textContent = 'Load failed: ' + e.message;
    console.error(e);
  }
})();
</script>
</body></html>
<!-- KM-ALIAS-FIX: map machine_id -> alias after page load -->
<script>
(function(){
  const run = async () => {
    try{
      const res = await fetch('machine_aliases.json', {cache:'no-store'});
      if(!res.ok) return;
      const alias = await res.json();

      // à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹à¸—à¸™à¸‚à¹‰à¸­à¸„à¸§à¸²à¸¡à¸„à¸­à¸¥à¸±à¸¡à¸™à¹Œà¸Šà¸·à¹ˆà¸­à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¹ƒà¸™à¸•à¸²à¸£à¸²à¸‡ "à¸ªà¸–à¸²à¸™à¸°à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡"
      const replaceCell = (td) => {
        if(!td) return;
        const raw = (td.textContent||'').trim();
        const friendly = alias[raw];
        if(friendly && friendly !== raw) td.textContent = friendly;
      };

      // à¸«à¸² section à¸—à¸µà¹ˆà¸«à¸±à¸§à¸‚à¹‰à¸­à¸¡à¸µà¸„à¸³à¸§à¹ˆà¸² "à¸ªà¸–à¸²à¸™à¸°à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡"
      document.querySelectorAll('h1,h2,h3').forEach(h => {
        if(/à¸ªà¸–à¸²à¸™à¸°à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡/.test(h.textContent||'')) {
          // à¸•à¸²à¸£à¸²à¸‡à¹à¸£à¸à¹ƒà¸•à¹‰à¸«à¸±à¸§à¸‚à¹‰à¸­à¸™à¸µà¹‰
          const table = h.parentElement && h.parentElement.querySelector('table');
          if (table) {
            table.querySelectorAll('tbody tr').forEach(tr => replaceCell(tr.cells && tr.cells[0]));
          }
        }
      });
    }catch(e){ console.error('alias-fix:', e); }
  };
  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', run); else run();
})();
</script>
<!-- /KM-ALIAS-FIX -->
<!-- KM-CACHE-BUST -->
<script>
(function(){
  const bust = '?t='+(Date.now());
  const _fetch = window.fetch;
  window.fetch = function(input, init){
    try{
      if(typeof input==='string' && /(^data\.json$|^machine_aliases\.json$)/.test(input)){
        input = input + (input.includes('?')?'&':'?') + 'v=' + Date.now();
      }
    }catch(e){}
    return _fetch(input, init);
  };
})();
</script>
<!-- /KM-CACHE-BUST -->


