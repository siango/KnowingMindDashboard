<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>[fix:20250909233055] [fix:20250909232604] KnowingMind Dashboard</title>
  <script src="config.env.js?v=20250909232604"></script>
  <script src="js/gas-client.js?v=20250909232604"></script>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Prompt,sans-serif;margin:0;background:#0b1020;color:#e5e7eb}
    .wrap{max-width:960px;margin:auto;padding:16px}
    pre{background:#0f172a;border:1px dashed #334155;border-radius:12px;padding:12px;overflow:auto}
    .banner{position:sticky;top:0;z-index:1000;background:#111827;padding:10px 14px;border-bottom:1px solid #334155}
  </style>
<script>
window.KMS = window.KMS || {};
if (typeof window.KMS.gasFetch !== 'function') {
  (function(){
    const GAS_URL = (window.KMS && window.KMS.GAS_URL) || '';
    const API_KEY = (window.KMS && window.KMS.API_KEY) || '';
    window.KMS.gasFetch = async function(params={}, method='GET', timeoutMs=12000){
      const ctl = new AbortController(); const to = setTimeout(()=>ctl.abort(), timeoutMs);
      try{
        const headers={'User-Agent':'KMDashboard/1.0'}; if(API_KEY) headers['X-API-Key']=API_KEY;
        if(method==='GET'){
          const qs=new URLSearchParams(params).toString();
          const url = qs ? ${GAS_URL}??source=powershell&action=health : GAS_URL;
          const res = await fetch(url,{headers,signal:ctl.signal,cache:'no-store'});
          if(!res.ok) throw new Error(HTTP ); return await res.json();
        }else{
          headers['Content-Type']='application/json';
          const res=await fetch(GAS_URL,{method:'POST',headers,body:JSON.stringify(params),signal:ctl.signal});
          if(!res.ok) throw new Error(HTTP ); return await res.json();
        }
      }catch(e){
        // JSONP fallback
        return new Promise((resolve,reject)=>{
          const cb=KMS_JSONP__;
          window[cb]=(data)=>{ resolve(data); cleanup(); };
          function cleanup(){ try{delete window[cb]}catch(_){};
            if(s) s.remove(); clearTimeout(tt); }
          const u=new URL(GAS_URL);
          Object.entries(params||{}).forEach(([k,v])=>u.searchParams.set(k,v));
          u.searchParams.set('callback',cb);
          const s=document.createElement('script'); s.src=u.toString();
          s.onerror=()=>{ cleanup(); reject(new Error('JSONP load error')); };
          document.head.appendChild(s);
          const tt=setTimeout(()=>{ cleanup(); reject(new Error('JSONP timeout')); }, timeoutMs);
        });
      } finally { clearTimeout(to); }
    };
    console.log('[km] inline fallback: KMS.gasFetch ready');
  })();
}
</script>
</head>
<body>
  <div class="banner"><b id="ai-status">loading…</b></div>
  <div class="wrap">
    <h1>KnowingMind Dashboard</h1>
    <p>ผลลัพธ์จาก GAS (health + dashboard)</p>
    <pre id="out">Loading…</pre>
  </div>

  <script>
  (async()=>{
    const el = document.getElementById('out');
    const banner = document.getElementById('ai-status');
    try{
      const h = await KMS.gasFetch({action:'health', source:'pages'}, 'GET');
      let txt = 'health: ' + (h && (h.ping||h.ok) );
      try{
        const d = await KMS.gasFetch({action:'dashboard'}, 'GET');
        el.textContent = JSON.stringify({ health:h, dashboard:d }, null, 2);
        txt += ' | dashboard: ok';
      }catch(e){
        el.textContent = JSON.stringify({ health:h, dashboard_error:e.message }, null, 2);
        txt += ' | dashboard: ' + e.message;
      }
      banner.textContent = txt + ' @ ' + new Date().toLocaleString('th-TH',{hour12:false});
    }catch(e){
      banner.textContent = 'Load failed: ' + e.message;
      el.textContent = 'ERR: ' + e.message;
      console.error(e);
    }
  })();
  </script>
</body>
</html>

