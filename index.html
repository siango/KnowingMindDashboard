<!DOCTYPE html><html lang="th"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>KnowingMind Dashboard</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<style>
:root{--bg:#0f1623;--panel:#121a29;--ink:#e6eefc;--minor:#9bb3d1;--ok:#10b981;--bad:#ef4444;--card:#0b1320;--line:#1e2b45}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto}
.wrap{display:flex;min-height:100vh}
aside{width:240px;background:var(--panel);padding:18px}
.brand{font-weight:700;margin-bottom:12px}
.tab{display:block;width:100%;text-align:left;background:#0d1a30;border:1px solid var(--line);color:#cfe2ff;
     padding:10px 12px;margin:6px 0;border-radius:8px;cursor:pointer}
.tab:hover,.tab.active{background:#0d1a3a;color:#fff}
main{flex:1;padding:22px;overflow:auto}
h1{margin:6px 0 10px}
.bar{font-size:14px;color:var(--minor);margin-bottom:16px}
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin:12px 0 18px}
.card{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:14px}
.k{color:var(--minor)}
.chip{display:inline-block;font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #27476b;margin-left:6px}
.ok{color:#caffd7;border-color:#13543c;background:#042d20} .bad{color:#ffd1d1;border-color:#542323;background:#2a0c0c}
pre{background:#0b1320;color:#b9d1ff;border:1px dashed #27476b;border-radius:10px;padding:14px;overflow:auto}
.row{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
.btn{background:#1a2b44;border:1px solid var(--line);color:#e6eefc;border-radius:10px;padding:8px 12px;cursor:pointer}
.btn:hover{filter:brightness(1.1)}
.input{background:#0d1524;border:1px solid var(--line);color:#e6eefc;border-radius:8px;padding:8px 10px}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:8px;text-align:left}
th{background:#0d1a3a}
.footer{opacity:.6;font-size:12px;margin-top:20px}
</style>
</head>
<body>
<div class="wrap">
  <aside>
    <div class="brand">üìò KM Suite</div>
    <button class="tab active" data-page="home">üè† Home</button>
    <button class="tab" data-page="dashboard">üìä Dashboard</button>
    <button class="tab" data-page="ops">‚öôÔ∏è ‡∏Ñ‡∏≠‡∏°‡∏û‡πå & ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå</button>
    <button class="tab" data-page="gas">üõ†Ô∏è GAS</button>
  </aside>

  <main>
    <!-- HOME -->
    <section id="page-home">
      <h1>KnowingMind Dashboard</h1>
      <div class="bar" id="status-bar">loading‚Ä¶</div>
      <p>‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ó‡πá‡∏ö‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏ã‡πâ‡∏≤‡∏¢, ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GitHub Actions ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≤‡∏ü (Chart.js)</p>
      <div class="cards" id="cards"></div>
      <canvas id="barChart" height="160"></canvas>
      <canvas id="pieChart" height="160" style="margin-top:12px"></canvas>
    </section>

    <!-- DASHBOARD -->
    <section id="page-dashboard" hidden>
      <h1>Dashboard (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•)</h1>
      <div class="row">
        <button class="btn" id="btnRefresh">üîÑ Refresh</button>
        <button class="btn" id="btnAdd">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        <button class="btn" id="btnDownload">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON</button>
        <a class="btn" href="#" id="btnDeploy" title="‡πÄ‡∏£‡∏µ‡∏¢‡∏Å deploy ‡∏ú‡πà‡∏≤‡∏ô Termux alias">üöÄ Trigger Deploy</a>
      </div>

      <table id="tbl" hidden>
        <thead><tr><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</th><th>‡πÄ‡∏™‡∏£‡πá‡∏à</th><th>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</th></tr></thead>
        <tbody></tbody>
      </table>

      <div id="form" class="row" hidden>
        <input class="input" id="fName"  placeholder="‡∏ä‡∏∑‡πà‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô Tasks"/>
        <input class="input" id="fTot"   type="number" min="0" value="0"/>
        <input class="input" id="fDone"  type="number" min="0" value="0"/>
        <button class="btn" id="fSave">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
        <button class="btn" id="fCancel">‚úñÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>

      <p class="k">JSON</p>
      <pre id="jsonbox">[]</pre>
      <div class="footer">‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏£‡∏¥‡∏á: <code>data.json</code> ‡πÉ‡∏ô‡∏™‡∏≤‡∏Ç‡∏≤ <code>gh-pages</code></div>
    </section>

    <!-- OPS -->
    <section id="page-ops" hidden>
      <h1>‡∏Ñ‡∏≠‡∏°‡∏û‡πå & ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå</h1>
      <p>‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÅ‡∏ö‡∏ö 1 ‡∏Ñ‡∏•‡∏¥‡∏Å:</p>
      <ol>
        <li>‡∏ö‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠: ‡πÉ‡∏ä‡πâ <b>Termux Widget</b> ‡∏õ‡∏∏‡πà‡∏° <code>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó_Dashboard</code></li>
        <li>‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏ô Termux: ‡∏û‡∏¥‡∏°‡∏û‡πå <code>km-update</code></li>
      </ol>
      <div class="row">
        <a class="btn" href="termux://">‡πÄ‡∏õ‡∏¥‡∏î Termux</a>
        <a class="btn" target="_blank" id="runsLink">‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</a>
      </div>
      <p class="k">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GitHub Actions</p>
      <pre id="runs">loading‚Ä¶</pre>
    </section>

    <!-- GAS -->
    <section id="page-gas" hidden>
      <h1>‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å GAS (health + dashboard)</h1>
      <pre id="gas">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</pre>
    </section>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
/* ====== Config ‡∏ó‡∏µ‡πà‡∏ù‡∏±‡∏á‡∏°‡∏≤‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏à ====== */
window.KM_CONFIG = {
  user:  "siango",
  repo:  "KnowingMindDashboard",
  gasUrl: ""  // ‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏î‡πâ
};

/* ====== ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ó‡πá‡∏ö ====== */
const tabs=[...document.querySelectorAll('.tab')];
const pages={
  home:document.getElementById('page-home'),
  dashboard:document.getElementById('page-dashboard'),
  ops:document.getElementById('page-ops'),
  gas:document.getElementById('page-gas'),
};
tabs.forEach(btn=>{
  btn.onclick=()=>{
    tabs.forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    Object.values(pages).forEach(p=>p.hidden=true);
    pages[btn.dataset.page].hidden=false;
  };
});

/* ====== Utilities ====== */
const $ = (s, p=document)=>p.querySelector(s);
const $$= (s, p=document)=>[...p.querySelectorAll(s)];
const fmt = n => new Intl.NumberFormat('th-TH').format(n);
const state = { data:[], editIndex:-1, bar:null, pie:null };

/* ====== ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (data.json) ====== */
async function loadDataJson(){
  try{
    const r = await fetch('data.json', {cache:'no-store'});
    if(!r.ok) throw new Error(r.status);
    const j = await r.json();
    state.data = Array.isArray(j)? j : [];
  }catch(e){
    // fallback mock
    state.data = [
      {name:'Tasks', total:42, done:31},
      {name:'Goals', total:12, done:7},
      {name:'Devices', total:5,  done:5},
    ];
  }
  $('#jsonbox').textContent = JSON.stringify(state.data,null,2);
  renderTable(); renderCards(); renderCharts();
}

/* ====== ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡∏≤‡∏£‡πå‡∏î/‡∏Å‡∏£‡∏≤‡∏ü ====== */
function renderCards(){
  const cards = $('#cards');
  const sumTotal = state.data.reduce((a,b)=>a+b.total,0);
  const sumDone  = state.data.reduce((a,b)=>a+b.done,0);
  cards.innerHTML = `
    <div class="card"><div><b>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</b></div>
      <div class="k">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div>${fmt(sumTotal)}</div>
      <div class="k">‡πÄ‡∏™‡∏£‡πá‡∏à</div><div>${fmt(sumDone)}</div>
    </div>
    ${state.data.map(x=>`
      <div class="card">
        <div><b>${x.name}</b> <span class="chip ${x.done>=x.total?'ok':''}">
          ${x.done}/${x.total}</span></div>
        <div class="k">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div><div>${fmt(Math.max(0,x.total-x.done))}</div>
      </div>`).join('')}
  `;
}
function renderCharts(){
  const names = state.data.map(x=>x.name);
  const totals= state.data.map(x=>x.total);
  const dones = state.data.map(x=>x.done);
  const remain= totals.map((t,i)=>Math.max(0,t-dones[i]));

  if(state.bar) state.bar.destroy();
  state.bar = new Chart($('#barChart'), {
    type:'bar',
    data:{ labels:names, datasets:[
      {label:'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', data:totals},
      {label:'‡πÄ‡∏™‡∏£‡πá‡∏à',   data:dones},
      {label:'‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠', data:remain},
    ]},
    options:{ responsive:true, plugins:{legend:{position:'bottom'}} }
  });

  if(state.pie) state.pie.destroy();
  const sumDone  = dones.reduce((a,b)=>a+b,0);
  const sumTotal = totals.reduce((a,b)=>a+b,0);
  state.pie = new Chart($('#pieChart'), {
    type:'pie',
    data:{ labels:['‡πÄ‡∏™‡∏£‡πá‡∏à','‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠'], datasets:[{ data:[sumDone,Math.max(0,sumTotal-sumDone)] }]},
    options:{ plugins:{legend:{position:'bottom'}} }
  });
}

/* ====== ‡∏ï‡∏≤‡∏£‡∏≤‡∏á + ‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç ====== */
function renderTable(){
  const tbl=$('#tbl'), tb=tbl.querySelector('tbody'); tbl.hidden=false;
  tb.innerHTML = state.data.map((x,i)=>`
    <tr>
      <td>${x.name}</td>
      <td>${fmt(x.total)}</td>
      <td>${fmt(x.done)}</td>
      <td><button class="btn" data-i="${i}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button></td>
    </tr>
  `).join('');
  $$('#tbl .btn').forEach(b=>{
    b.onclick=()=>{
      const i=Number(b.dataset.i); state.editIndex=i;
      $('#form').hidden=false;
      $('#fName').value = state.data[i].name;
      $('#fTot').value  = state.data[i].total;
      $('#fDone').value = state.data[i].done;
    };
  });
}
$('#btnAdd').onclick=()=>{ state.editIndex=-1; $('#form').hidden=false;
  $('#fName').value=''; $('#fTot').value=0; $('#fDone').value=0; };
$('#fCancel').onclick=()=>$('#form').hidden=true;
$('#fSave').onclick=()=>{
  const obj = {name:$('#fName').value.trim(), total:Number($('#fTot').value||0), done:Number($('#fDone').value||0)};
  if(!obj.name) return;
  if(state.editIndex<0) state.data.push(obj); else state.data[state.editIndex]=obj;
  $('#jsonbox').textContent = JSON.stringify(state.data,null,2);
  renderTable(); renderCards(); renderCharts();
  $('#form').hidden=true;
};
/* ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON */
$('#btnDownload').onclick=()=>{
  const blob = new Blob([JSON.stringify(state.data,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='data.json'; a.click();
  setTimeout(()=>URL.revokeObjectURL(url),500);
};
/* Refresh */
$('#btnRefresh').onclick=()=>loadAll();

/* ‡∏õ‡∏∏‡πà‡∏° Trigger Deploy: ‡πÅ‡∏Ñ‡πà‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÑ‡∏õ‡∏Å‡∏î‡∏ó‡∏µ‡πà Termux (‡πÄ‡∏£‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö) */
$('#btnDeploy').onclick=(e)=>{
  e.preventDefault();
  alert('‡πÉ‡∏´‡πâ‡∏™‡∏•‡∏±‡∏ö‡πÑ‡∏õ Termux ‡πÅ‡∏•‡πâ‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå: km-update  ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î‡∏ß‡∏¥‡∏î‡πÄ‡∏à‡πá‡∏ï "‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó_Dashboard"');
};

/* ====== ‡∏î‡∏∂‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GitHub Actions ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå ====== */
async function loadRuns(){
  const u = window.KM_CONFIG.user, r = window.KM_CONFIG.repo;
  const api = `https://api.github.com/repos/${u}/${r}/actions/runs?per_page=1`;
  const res = await fetch(api, {cache:'no-store'}); const j = await res.json();
  const run = (j.workflow_runs||[])[0];
  const bar = document.getElementById('status-bar');
  const txt = run ? `health: alive | last run: ${run.status}/${run.conclusion||'-'} @ ${new Date(run.updated_at).toLocaleString('th-TH',{hour12:false})}` 
                  : 'no runs';
  bar.textContent = txt;
  const pre = document.getElementById('runs');
  pre.textContent = JSON.stringify(run||{}, null, 2);
  document.getElementById('runsLink').href = run?.html_url || `https://github.com/${u}/${r}/actions`;
}

/* ====== GAS (‡∏ñ‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ URL) ====== */
async function loadGas(){
  const url = window.KM_CONFIG.gasUrl;
  if(!url){ document.getElementById('gas').textContent='(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ GAS_URL)'; return; }
  try{
    const res = await fetch(url, {cache:'no-store'});
    const j   = await res.json();
    document.getElementById('gas').textContent = JSON.stringify(j,null,2);
  }catch(e){
    document.getElementById('gas').textContent = '‡πÇ‡∏´‡∏•‡∏î GAS ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+e;
  }
}

/* ====== ‡∏£‡∏ß‡∏°‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ====== */
async function loadAll(){ await loadDataJson(); await loadRuns(); await loadGas(); }
loadAll(); setInterval(loadRuns, 15000); // refresh ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏∏‡∏Å 15s
</script>
</body></html>
